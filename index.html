<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Avaloka – 3 Card Analysis</title>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
  body {
    margin: 0;
    background: #eef1f6;
    font-family: system-ui, -apple-system;
    touch-action: none;
  }

  .layout {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 10px;
    padding: 10px;
    height: 100vh;
  }

  .card {
    background: white;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.1);
    position: relative;
    overflow: hidden;
  }

  canvas, video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .title {
    position: absolute;
    top: 8px;
    left: 10px;
    font-size: 13px;
    font-weight: 700;
    opacity: 0.7;
  }

  /* DATA CARD */
  .data {
    padding: 12px;
    font-size: 14px;
    font-weight: 600;
  }

  .row { margin-bottom: 8px; }
  .green { color: #0a9d44; }
  .orange { color: #e67e22; }
  .red { color: #d63031; }

  /* MOBILE */
  @media (max-width: 900px) {
    .layout {
      grid-template-columns: 1fr;
      grid-template-rows: 2fr 1fr 1fr;
    }
  }
</style>
</head>

<body>

<div class="layout">

  <!-- CARD 1: SKELETON -->
  <div class="card">
    <div class="title">Skeleton + Angles</div>
    <canvas id="canvas"></canvas>
  </div>

  <!-- CARD 2: CAMERA -->
  <div class="card">
    <div class="title">Live Camera</div>
    <video id="video" playsinline></video>
  </div>

  <!-- CARD 3: DATA -->
  <div class="card data" id="dataCard">
    <div class="title">Data</div>
    <div class="row">Waiting for pose…</div>
  </div>

</div>

<script>
/* ---------- BASIC ---------- */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const dataCard = document.getElementById("dataCard");

function resize() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
}
window.addEventListener("resize", resize);
resize();

/* ---------- ANGLES ---------- */
function angle360(p1, p2) {
  let a = Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;
  if (a < 0) a += 360;
  return a;
}
function normalize90(a) {
  a = a % 180;
  if (a > 90) a = 180 - a;
  return Math.abs(a);
}
function center(a,b){ return {x:(a.x+b.x)/2, y:(a.y+b.y)/2}; }

function color(v) {
  if (v <= 10) return "green";
  if (v <= 20) return "orange";
  return "red";
}

/* ---------- POSE ---------- */
const pose = new Pose({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6
});

pose.onResults(onResults);

/* ---------- CAMERA ---------- */
const camera = new Camera(video, {
  facingMode: "environment",
  onFrame: async () => {
    await pose.send({ image: video });
  }
});
camera.start();

/* ---------- DRAW LABEL ---------- */
function drawLabel(text, x, y, c) {
  ctx.fillStyle = c;
  ctx.font = "13px system-ui";
  ctx.fillText(text, x * canvas.width + 6, y * canvas.height - 6);
}

/* ---------- MAIN ---------- */
function onResults(res) {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if (!res.poseLandmarks) return;

  const lm = res.poseLandmarks;
  drawConnectors(ctx, lm, POSE_CONNECTIONS, { color:"#0077ff", lineWidth:3 });

  const hipC = center(lm[23], lm[24]);
  const shoulderC = center(lm[11], lm[12]);

  const angles = {
    Head: normalize90(angle360(lm[7], lm[8])),
    Torso: normalize90(Math.abs(angle360(hipC, shoulderC) - 270)),
    Hip: normalize90(angle360(lm[23], lm[24])),
    Shoulder: normalize90(angle360(lm[11], lm[12])),
    Arm: normalize90(Math.abs(angle360(lm[11], lm[13]) - angle360(hipC, lm[11]))),
    Bat: normalize90(Math.abs(angle360(lm[15], lm[16]) - 270))
  };

  /* Draw on skeleton */
  drawLabel(`Head ${angles.Head}°`, lm[0].x, lm[0].y, color(angles.Head));
  drawLabel(`Torso ${angles.Torso}°`, shoulderC.x, shoulderC.y, color(angles.Torso));
  drawLabel(`Bat ${angles.Bat}°`, lm[16].x, lm[16].y, color(angles.Bat));

  /* Data card */
  dataCard.innerHTML = `
    <div class="row ${color(angles.Head)}">Head: ${angles.Head}°</div>
    <div class="row ${color(angles.Torso)}">Torso: ${angles.Torso}°</div>
    <div class="row ${color(angles.Hip)}">Hip: ${angles.Hip}°</div>
    <div class="row ${color(angles.Shoulder)}">Shoulder: ${angles.Shoulder}°</div>
    <div class="row ${color(angles.Arm)}">Arm: ${angles.Arm}°</div>
    <div class="row ${color(angles.Bat)}">Bat: ${angles.Bat}°</div>
  `;
}
</script>

</body>
</html>
