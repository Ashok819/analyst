<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Avaloka – Angle Analysis</title>

<!-- MediaPipe -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
  body {
    margin: 0;
    background: #f4f6fb;
    font-family: system-ui, -apple-system;
    overflow: hidden;
    touch-action: none;
  }

  .container {
    display: flex;
    height: 100vh;
    padding: 8px;
    gap: 8px;
  }

  .panel {
    background: #fff;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    position: relative;
    overflow: hidden;
  }

  .skeleton-panel { flex: 8; }
  .video-panel { flex: 2; max-height: 28vh; }

  video, canvas {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Angle cards */
  .angles {
    position: absolute;
    top: 10px;
    left: 10px;
    display: grid;
    grid-template-columns: repeat(2, auto);
    gap: 6px;
  }

  .card {
    background: rgba(255,255,255,0.95);
    padding: 6px 10px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 2px 6px rgba(0,0,0,0.12);
  }

  .green { color: #0a9d44; }
  .orange { color: #e67e22; }
  .red { color: #d63031; }

  #feedback {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    padding: 6px 14px;
    font-size: 13px;
    font-weight: 600;
    background: rgba(255,255,255,0.95);
    border-radius: 16px;
  }

  @media (max-width: 768px) {
    .container { flex-direction: column; }
    .skeleton-panel { flex: 7; }
    .video-panel { flex: 3; }
  }
</style>
</head>

<body>
<div class="container">

  <!-- MAIN PANEL -->
  <div class="panel skeleton-panel">
    <canvas id="canvas"></canvas>

    <!-- ANGLE UI -->
    <div class="angles" id="angleCards"></div>

    <div id="feedback">Stand still – calibrating…</div>
  </div>

  <!-- VIDEO -->
  <div class="panel video-panel">
    <video id="video" playsinline></video>
  </div>

</div>

<script>
/* ================= BASIC SETUP ================= */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const angleCards = document.getElementById("angleCards");
const feedback = document.getElementById("feedback");

function resizeCanvas() {
  canvas.width = canvas.clientWidth;
  canvas.height = canvas.clientHeight;
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

/* ================= ANGLE MATH ================= */
function angle360(p1, p2) {
  const dx = p2.x - p1.x;
  const dy = p2.y - p1.y;
  let a = Math.atan2(dy, dx) * 180 / Math.PI;
  if (a < 0) a += 360;
  return a;
}

function normalize90(a) {
  a = a % 180;
  if (a > 90) a = 180 - a;
  return Math.abs(a);
}

function center(a, b) {
  return { x: (a.x + b.x) / 2, y: (a.y + b.y) / 2 };
}

/* ================= COLOR RULE ================= */
function colorClass(v, g, y) {
  if (v <= g) return "green";
  if (v <= y) return "orange";
  return "red";
}

/* ================= POSE ================= */
const pose = new Pose({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`,
});

pose.setOptions({
  modelComplexity: 1,
  smoothLandmarks: true,
  minDetectionConfidence: 0.6,
  minTrackingConfidence: 0.6,
});

pose.onResults(onResults);

/* ================= CAMERA ================= */
const camera = new Camera(video, {
  facingMode: "environment",
  onFrame: async () => {
    await pose.send({ image: video });
  },
});
camera.start();

/* ================= CALIBRATION ================= */
let calibrated = false;
let calStart = Date.now();

/* ================= MAIN LOOP ================= */
function onResults(results) {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!results.poseLandmarks) return;

  const lm = results.poseLandmarks;

  drawConnectors(ctx, lm, POSE_CONNECTIONS, {
    color: "#0066ff",
    lineWidth: 3,
  });

  if (!calibrated) {
    if (Date.now() - calStart > 1500) {
      calibrated = true;
      feedback.innerText = "Live angles";
    } else {
      feedback.innerText = "Stand still – calibrating…";
      return;
    }
  }

  const hipCenter = center(lm[23], lm[24]);
  const shoulderCenter = center(lm[11], lm[12]);

  const angles = {
    Head: normalize90(angle360(lm[7], lm[8])),
    Torso: normalize90(Math.abs(angle360(hipCenter, shoulderCenter) - 270)),
    Shoulder: normalize90(angle360(lm[11], lm[12])),
    Hip: normalize90(angle360(lm[23], lm[24])),
    Separation: normalize90(
      Math.abs(angle360(lm[11], lm[12]) - angle360(lm[23], lm[24]))
    ),
    UpperArm: normalize90(
      Math.abs(angle360(lm[11], lm[13]) - angle360(hipCenter, lm[11]))
    ),
    Forearm: normalize90(
      Math.abs(angle360(lm[13], lm[15]) - angle360(lm[11], lm[13]))
    ),
    Bat: normalize90(Math.abs(angle360(lm[15], lm[16]) - 270)),
  };

  angleCards.innerHTML = "";
  for (const k in angles) {
    const v = angles[k].toFixed(0);
    const cls = colorClass(v, 10, 20);
    angleCards.innerHTML +=
      `<div class="card ${cls}">${k}: ${v}°</div>`;
  }
}
</script>
</body>
</html>
